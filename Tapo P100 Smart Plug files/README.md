# Tapo P100 Tp-Link Smart Plug

In this page you can find files related with Tapo P100 smart plug

Relevant details of addresses throughout the pcaps:

#### IoT device
- **Tapo plug IP address: 10.42.0.170**
- **Tapo plug MAC address: 98:25:4a:50:4f:95**
- Main servers the plug contacts:
    - **security.iot.i.tplinknbu.com** - cloud server responsable most probably for firmware updates
    - **euw1-device-cloudgateway.iot.i.tplinknbu.com** - cloud server responsable to deliver actions initiated from the APP and get status updates from the IoT

#### Hotspot config
- **Gateway IP: 10.42.0.1**
- **MAC address: 0c:96:e6:3d:59:17**
- **IPv6 address: fe80::dd4a:b925:122c:343a**

#### Mobile companion
- **Mobile device IP: 10.42.0.46**


## Group11-Tapo_P100_Smart_Plug pcap:

This PCAP contains a trace of approximately 40 minutes of the captured active traffic.
The captured traffic contains active interactions with the device both physically (ON/OFF button on the device itself) and from the companion APP (the most relevant actions) on an android device connected to a different network (not captured in this pcap). The companion APP traffic was captured in a separate pcap as it communicates directly (i.e. not through the cloud server) with the device when on the same network.

#### Note: use the following Wireshark filter for a better visualization: *(not arp and not dhcp)*
 
### Overview of Interactions
Packet number and packet timestamp are used to highlight the most relevant points and interactions in the pcap.

#### Initialization
1) **No. 21 (1.042294407)** - after DHCP resolution, the device connects to the hotspot and initiates DNS queries for the following domain names:
    - security.iot.i.tplinknbu.com -> 34.242.245.238
    - euw1-device-cloudgateway.iot.i.tplinknbu.com -> 54.170.92.104/34.241.185.170

2) **No. 30 (1.191457056)** - TLS handshake with *security.iot.i.tplinknbu.com* server

3) **No. 60 (2.110494473)** - TLS handshake with *euw1-device-cloudgateway.iot.i.tplinknbu.com* server

#### Note: Each 3/4 minutes fixed size (123 byte packet both request and answer from the cloud) TLS traffic is generated by the device to the cloud server. Most probably ping requests. An example at packet no. 248-249.


#### Physical interaction with the device (ON/OFF button)
1) **No. 115** (25.893797888) - ON
2) **No. 118** (95.023948447) - OFF

Both actions generate requests and responses with have the same packet size, 315 bytes, which make them indistinguishable.

#### Remote interaction from the companion APP
1) **No. 148** (250.437427020) - App displays the device section which generates a request to the device, most likely its status, as the response from the device is quite big (packet no. 150, 987 bytes).
2)  **No. 252** (644.277234068) - OFF action
3) **No. 261** (727.632088063) - ON action

Both actions generate requests and responses with have the same packet size, 443 bytes, which make them indistinguishable. But distinguishable from the physical actions.

4) **No. 274** (907.755773930) - App displays the device settings section which again generates a request to the device for its status most likely
5) **No. 287** (987.014616953) - LED OFF
6) **No. 298** (1096.378998724) - LED Night Mode
7) **No. 307** (1142.356112633) - LED Auto Mode

As it can be observed from the requests packet size, 363, 443 and 363 bytes respectively, the Night Mode requires more data as it specifies the time interval for the mode to be active.

8) **No. 406** (1336.405850503) - App displays schedule page. The device responds with a 363 bytes packet, which is bigger than the response generated when opening the Timer or Away section (no. 451 with a response of 347 bytes).

9) **No. 455** (1572.747193286) - Timer turn OFF in 1 minute
    - **No. 468** Action triggers a request from the device to the cloud, most likely to update its status on the server.

10) **No. 478** (1679.449353365) - Timer turn ON in 1 minute
    - **No. 486** - Action triggers a request from the device to the cloud, most likely to update its status on the server.

The Timer turn ON action generates a request from the cloud to the device bigger than the Timer turn OFF (459 bytes vs 411 bytes). Once the action is triggered however, the responses from the device have the same packet size.

11) **No. 510** (1812.262634265) - Schedule OFF
12) **No. 530** (1935.451026781) - Schedule ON

The Schedule OFF action generates a request of 523 bytes which is smaller than the Schedule ON action with 619 bytes, making this actions distinguishable. The triggering of the action however is indistinguishable (no. 523 for OFF and no. 542 for ON - 299 bytes).


## Inside MUD files folder:

Inside this folder you can inspect the files generated by the Mudgee tool. We included the mud configuration json file used for the generation. The Mudgee tool outputs *ipflows* and *rule* csv files, as well as the json MUD file which we manually included in this directory. The pcap we used for the generation is the  PCAP presented and explained above.


## Scripts files folder:
contains 4 small scripts. 
- **pcap-scapy** - given a PCAP file, lists all the unique IPs captured, the unique endpoint connections and DNS communications. We used this script to verify the validity of the generated Mud file and for general analysis.

- **cloud-api-tapo.py** - retrieves information stored in the cloud about all devices linked to a given TPLink account. As we explain in the report, this method bypasses the Two Factor Authentication imposed by the offical companion APP which in our opinion is concerning as it allows retrieving sensitive information about the devices such as the MAC address, region, device type, hardware and firmware version. This script should also allow sending remote actions and be used as a complete substitute of the companion APP. However, this second functionality was not tested thoroughly.

- **discovery.py** - discovers the device on the LOCAL network, which can then be used with **action.py** to send actions to the device, again LOCALLY, through HTTP requests.

As explained in the report, the scripts that allow local interaction (**discovery.py** and **action.py**) have a far better discovery mechanism, generating few UDP broadcast packets when compared to the official companion APP which generates 100 UDP packets even after a successful discovery.