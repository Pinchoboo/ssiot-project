# Tapo P100 Tp-Link Smart Plug - local traffic of App and smart plug

## app-and-device.pcapng

This PCAP contains a trace of approximately 30 minutes of the captured **active** local traffic generated by *Tapo* companion App and the smart plug.

#### IoT device
- **Tapo plug IP address: 10.42.0.170**
- **Tapo plug MAC address: 98:25:4a:50:4f:95**
- Main servers the plug contacts (check *"dns and ip.addr == 10.42.0.170"* wireshark filter):
    - **security.iot.i.tplinknbu.com** - cloud server responsable most probably for firmware updates
    - **euw1-device-cloudgateway.iot.i.tplinknbu.com** - cloud server responsable to deliver actions initiated from the APP and get status updates from the IoT

#### Hotspot config
- **Gateway IP: 10.42.0.1**
- **MAC address: 0c:96:e6:3d:59:17**
- **IPv6 address: fe80::dd4a:b925:122c:343a**

#### Mobile companion
- **Mobile device IP: 10.42.0.46**
- Main servers the App contacts (check *"dns and ip.addr == 10.42.0.46"* wireshark filter):
    - **n-euw1-wap-gw.tplinkcloud.com**
    - **euw1-app-server.iot.i.tplinknbu.com** 
    - **euw1-app-tapo-care.i.tplinknbu.com**
    - **api.tplinkra.com**

#### NOTE: For the App traffic capturing, a resetted android smartphone was used. However, the host still generated lots of irrelevant traffic, thus we had to manually filter many of the IPs contacted, such as Google and Microsoft servers. Use the following wireshark filter for a better visualization:
	(not arp and not quic and ip.addr not in {142.0.0.0/8, 172.0.0.0/8, 184.30.249.151, 4.153.25.145, 34.104.35.123, 216.58.208.110, 4.152.45.255, 216.58.208.106, 35.241.30.194, 34.149.250.49, 80.158.19.121, 20.166.89.152, 152.199.19.161, 216.58.214.10})

## Observations
1) **No. 247** (122.969037238) - as we run the APP (in foreground), it starts a device discovery process by sending UDP broadcast packets at *port 20002* and *20004* with the following json payload structure in plaintext:

```json
{
    "params": {
        "rsa_key": "-----BEGIN PUBLIC KEY-----<PARTIALLY RANDOM PAYLOAD>-----END PUBLIC KEY-----\n"
    }
}
```
The field contains a starting and ending fixed sequence, while the middle part seems random accross different discovery attempts. Additionally, the payload contains 8 random bytes in different discovery attempts.

This broadcast discovery happens only when the APP is in foreground (in order to run in background, android apps required special permissions), in the *home* section (and a few other place) at fixed intervals, around 30 seconds, or by clicking on these sections. This behavior can be better observed in the **app-broadcast.pcapng** file.

The issue is that each time the APP sends arround 100 UDP packets, and can be triggered by navigating the APP, which in our opinion is a bad implementation.

We also note that the scripts we provided for interacting with the devices on the local network, have a far better discovery mechanism. 

2) **No. 790** (124.317185717) - once the device receives this packets, it answers the APP with UDP packets containing the following json payload in plaintext:
```json
{
  "result": {
    "device_id": "DEVICE_ID",
    "owner": "OWNER",
    "device_type": "SMART.TAPOPLUG",
    "device_model": "P100(EU)",
    "ip": "10.42.0.170",
    "mac": "98-25-4A-50-4F-95",
    "is_support_iot_cloud": true,
    "obd_src": "tplink",
    "protocol_version": 1,
    "factory_default": false,
    "mgt_encrypt_schm": {
      "is_support_https": false,
      "encrypt_type": "KLAP",
      "http_port": 80,
      "lv": 2
    }
  },
  "error_code": 0
}
```
The device continues to send multiple such packets at random ports on the App host. In fact, we can observe many of the packets are droped since only one port is opened at a time.

As it can be observed, sensitive information regarding the device is broadcasted at 255.255.255.255. Note that *KLAP* encryption scheme is proprietary crypto scheme used by TPLINK, which was introduced as a substitute of AES. More at https://community.tp-link.com/us/home/forum/topic/620314.

3) **No. 795** (124.382223999) - once the discovery is successful, a TCP and a custom HTTP handshake takes place. The device runs an HTTP server on port 80, which is used by the APP to send actions directly to the device without using the cloud server. We note that the HTTP is still encrypted, most probably with the *KLAP* crypto scheme as indicated in the payload sent by the plug.

    The handshake is done in 2 steps:
    - **No. 798** - POST request to */app/handshake1*
    - **No. 802** - POST request to */app/handshake2*

    We also observe periodical (most likely) pings (e.g. packet **no. 812**).

4) **No. 1721** (549.103730957) - ON action
5) **No. 1745** (606.876231918) - OFF action

    We note that each POST request has a *sequence number*. The initial sequence number is decided during the HTTP handshake and seems to be random each time.

    Additionally, we note that both the requests from the APP to the device (direct communication) and the requests from the device to the cloud, to update its state, have different size. This could potentially be used by an attacker which has insights on these patterns.

6) The same actions, as in the main PCAP file, were tested and different size packets were observed for different actions, which again could be used for tracking the user, even if the attack would require to connect to the local network first to observe the traffic.